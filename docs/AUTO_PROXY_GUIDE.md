# 自动代理管理器使用指南

## 概述

自动代理管理器是一个智能的代理节点管理系统，能够自动测试、评分、选择和切换最佳的代理节点，为用户提供稳定高效的代理服务。

## 主要功能

### 🚀 核心功能
- **自动节点测试**: 并发测试所有订阅节点，评估连通性和性能
- **智能节点评分**: 基于延迟和速度的综合评分算法
- **自动节点切换**: 根据评分自动选择和切换到最佳节点
- **定时更新**: 定期重新测试节点，保持最新状态
- **多协议支持**: 支持V2Ray和Hysteria2协议

### 🛡️ 增强功能
- **节点黑名单**: 自动将持续失败的节点加入黑名单，避免重复测试
- **配置验证**: 启动前验证所有配置参数的有效性
- **错误重试机制**: 智能重试失败的测试，提高成功率
- **性能监控**: 跟踪节点性能历史和系统状态
- **资源清理**: 自动清理过期数据和临时文件

## 使用方法

### 基本使用

#### 1. 启动自动代理（默认配置）
```bash
./v2ray-manager auto-proxy <订阅链接>
```

#### 2. 启动自动代理（自定义配置）
```bash
./v2ray-manager auto-proxy-config <订阅链接> [选项]
```

**可用选项：**
- `--http-port=端口`: HTTP代理端口（默认：7890）
- `--socks-port=端口`: SOCKS代理端口（默认：7891）
- `--interval=分钟`: 更新间隔分钟数（默认：10）
- `--concurrency=数量`: 测试并发数（默认：20）
- `--timeout=秒数`: 测试超时秒数（默认：30）
- `--test-url=URL`: 测试URL（默认：http://www.google.com）
- `--max-nodes=数量`: 最大测试节点数（默认：100）
- `--no-auto-switch`: 禁用自动切换

**示例：**
```bash
./v2ray-manager auto-proxy-config https://example.com/sub \
  --http-port=8080 \
  --socks-port=8081 \
  --interval=15 \
  --concurrency=10 \
  --timeout=20
```

#### 3. 查看系统状态
```bash
./v2ray-manager auto-proxy-status
```

#### 4. 查看节点黑名单
```bash
./v2ray-manager auto-proxy-blacklist
```

#### 5. 停止自动代理
```bash
./v2ray-manager auto-proxy-stop
```

## 工作原理

### 节点测试流程
1. **获取订阅**: 从订阅链接获取节点列表
2. **黑名单过滤**: 跳过黑名单中的节点
3. **并发测试**: 使用多个工作协程并发测试节点
4. **性能评估**: 测量延迟和速度，计算综合评分
5. **结果排序**: 按评分从高到低排序节点

### 评分算法
```
综合评分 = 延迟评分 × 0.3 + 速度评分 × 0.7

其中：
- 延迟评分 = max(0, 100 - 延迟(ms)/10)
- 速度评分 = min(100, 速度(Mbps) × 10)
```

### 黑名单机制
- **触发条件**: 节点连续失败3次测试
- **黑名单时长**:
  - 超时错误: 30分钟
  - 连接拒绝: 1小时
  - 无路由: 2小时
  - 其他错误: 15分钟
- **自动清理**: 每5分钟清理过期的黑名单条目

### 自动切换策略
- **初始选择**: 启动时选择评分最高的节点
- **定期检查**: 每5分钟检查是否有更好的节点
- **故障切换**: 检测到当前节点异常时自动切换

## 配置参数说明

| 参数 | 默认值 | 说明 | 有效范围 |
|------|--------|------|----------|
| HTTPPort | 7890 | HTTP代理端口 | 1-65535 |
| SOCKSPort | 7891 | SOCKS代理端口 | 1-65535 |
| UpdateInterval | 10分钟 | 节点更新间隔 | ≥1分钟 |
| TestConcurrency | 20 | 测试并发数 | 1-100 |
| TestTimeout | 30秒 | 测试超时时间 | ≥5秒 |
| TestURL | http://www.google.com | 连通性测试URL | 有效URL |
| MaxNodes | 100 | 最大测试节点数 | ≥0 |
| MinPassingNodes | 5 | 最少通过节点数 | ≥0 |
| EnableAutoSwitch | true | 是否启用自动切换 | true/false |

## 状态文件

系统会自动创建以下文件来保存状态：

- `auto_proxy_state.json`: 系统状态和配置
- `valid_nodes.json`: 有效节点列表和性能数据

## 故障排除

### 常见问题

1. **配置验证失败**
   - 检查订阅URL是否有效
   - 确认端口号是否在有效范围内
   - 验证时间间隔和超时设置

2. **没有有效节点**
   - 检查网络连接
   - 尝试更换测试URL
   - 增加测试超时时间
   - 检查订阅链接是否可用

3. **代理连接失败**
   - 确认防火墙设置
   - 检查端口是否被占用
   - 验证代理软件是否正确安装

4. **节点频繁切换**
   - 调整更新间隔
   - 检查网络稳定性
   - 考虑禁用自动切换

### 日志分析

系统会输出详细的运行日志，包括：
- 节点测试结果
- 黑名单操作
- 代理切换记录
- 错误信息和重试情况

## 最佳实践

1. **合理设置并发数**: 根据网络带宽和CPU性能调整
2. **选择合适的测试URL**: 使用稳定可靠的测试站点
3. **定期清理状态文件**: 避免文件过大影响性能
4. **监控系统状态**: 定期检查运行状态和错误日志
5. **备份配置**: 保存有效的配置参数以便快速恢复

## 高级功能

### 自定义测试URL
可以使用自定义的测试URL来适应不同的网络环境：
```bash
--test-url=https://www.cloudflare.com
```

### 节点数量限制
限制测试的节点数量以提高测试速度：
```bash
--max-nodes=50
```

### 禁用自动切换
如果希望手动控制节点切换：
```bash
--no-auto-switch
```

## 技术架构

- **并发测试**: 使用Go协程池进行高效的并发测试
- **状态管理**: 线程安全的状态管理和持久化
- **错误处理**: 分类错误处理和智能重试机制
- **资源管理**: 自动清理和资源回收
- **信号处理**: 优雅关闭和状态保存 