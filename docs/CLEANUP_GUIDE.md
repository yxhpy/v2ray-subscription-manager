# 临时文件清理指南

## 问题描述

在使用auto-proxy功能时，系统会创建一些临时文件和状态文件：
- `auto_proxy_best_node.json` - 存储最佳节点信息
- `test_proxy_*.json` - 节点测试时的临时配置文件
- `auto_proxy_state.json` - 自动代理状态文件
- `valid_nodes.json` - 有效节点缓存文件
- 其他临时配置文件

之前版本中，当auto-proxy停止时，这些文件没有被完全清理，可能会遗留在工作目录中。

**新发现的问题：进程同步问题**

用户反馈发现，当清理进程结束时，其余进程可能还在运行，导致存在残留问题。这是因为：

1. **进程停止缺乏等待机制**：各个子进程停止时没有等待确认完全停止
2. **清理时机过早**：在所有进程完全停止前就开始清理文件
3. **缺乏进程验证**：没有验证进程是否真正停止
4. **文件删除时机不当**：在进程仍可能写入文件时就删除文件

## 修复内容

### 1. 增强的进程同步机制

#### AutoProxyManager 停止流程优化
- **分步骤停止**：按顺序停止测试进程、代理服务进程、主进程
- **等待机制**：每个进程停止后等待确认完全停止
- **超时处理**：设置最大等待时间（10-15秒），超时后强制终止
- **端口释放检查**：验证代理端口是否已释放
- **进程验证**：检查相关进程是否仍在运行

#### 新增的等待和验证方法
```go
// 等待单个进程停止（最大10秒）
waitForProcessStop(processName, checkFunc)

// 等待所有进程停止（最大15秒）
waitForAllProcessesStop()

// 检查所有进程是否已停止
checkAllProcessesStopped()

// 检查端口是否仍在使用
isPortInUse(port)

// 验证清理结果
verifyCleanup()
```

### 2. 改进的停止顺序

**新的9步停止流程：**

1. **停止测试进程** - 取消上下文，等待进程完全停止
2. **停止代理服务进程** - 关闭代理服务，等待端口释放
3. **停止主进程** - 取消主上下文
4. **等待所有进程停止** - 验证所有context已取消，端口已释放
5. **强制终止残留进程** - 使用pkill终止可能的残留进程
6. **等待进程终止完成** - 等待2秒确保进程完全终止
7. **清理资源** - 删除临时文件和状态文件
8. **验证清理结果** - 检查文件是否删除，进程是否停止
9. **保存最终状态** - 保存停止状态

### 3. 增强的清理工具

#### 文件清理重试机制
- **存在性检查**：删除前检查文件是否存在
- **重试机制**：删除失败时最多重试3次
- **智能退避**：每次重试间隔500ms
- **错误分类**：区分文件不存在和删除权限错误

#### 进程终止机制
```go
// 温和终止 (SIGTERM)
pkill -TERM -f processName

// 等待3秒让进程优雅退出
time.Sleep(3 * time.Second)

// 强制终止 (SIGKILL)
pkill -KILL -f processName
```

### 4. 完整的验证机制

#### 清理结果验证
- **文件检查**：验证关键文件是否已删除
- **进程检查**：验证相关进程是否仍在运行
- **端口检查**：验证代理端口是否已释放
- **重试删除**：发现残留文件时尝试再次删除

## 使用方法

### 1. 自动清理（推荐）

当正常停止auto-proxy时，系统会自动执行完整的清理流程：

```bash
# 正常停止auto-proxy（推荐）
./v2ray-manager auto-proxy stop

# 或使用 Ctrl+C 停止
```

### 2. 手动清理工具

如果发现残留文件或进程，可以使用独立的清理工具：

```bash
# 使用独立清理工具（包含进程终止）
./bin/cleanup

# 重新构建清理工具
./scripts/build_cleanup.sh
```

### 3. 清理工具功能

清理工具执行以下操作：

1. **终止相关进程**：v2ray、xray、hysteria2、hysteria
2. **清理临时文件**：test_proxy_*.json、temp_*.json 等
3. **清理状态文件**：auto_proxy_*.json、valid_nodes.json 等
4. **验证清理结果**：确保文件已删除，进程已停止
5. **显示详细日志**：显示清理过程和结果

## 故障排除

### 1. 文件删除失败

**现象**：清理时提示文件删除失败

**解决方案**：
- 确保auto-proxy完全停止后再运行清理工具
- 检查文件权限：`ls -la *.json`
- 手动删除：`rm -f auto_proxy_*.json test_proxy_*.json`

### 2. 进程残留

**现象**：清理后进程仍在运行

**解决方案**：
```bash
# 检查残留进程
ps aux | grep -E "(v2ray|hysteria2|xray)"

# 手动终止进程
pkill -KILL -f v2ray
pkill -KILL -f hysteria2
pkill -KILL -f xray
```

### 3. 端口占用

**现象**：重新启动时提示端口被占用

**解决方案**：
```bash
# 查看端口占用
lsof -i :7890
lsof -i :7891

# 终止占用端口的进程
kill -9 $(lsof -ti :7890)
kill -9 $(lsof -ti :7891)
```

### 4. 权限问题

**现象**：清理时提示权限错误

**解决方案**：
```bash
# 修改文件权限
chmod 666 *.json

# 使用sudo清理（不推荐）
sudo ./bin/cleanup
```

## 预防措施

1. **正常停止**：总是使用正确的停止命令而不是强制杀死进程
2. **等待停止**：停止命令后等待几秒钟让进程完全停止
3. **定期清理**：定期运行清理工具清除可能的残留文件
4. **监控日志**：关注停止过程中的错误信息

## 技术细节

### 超时设置

- **单个进程停止超时**：10秒
- **所有进程停止超时**：15秒
- **文件删除重试间隔**：500毫秒
- **进程终止等待时间**：3秒

### 检查机制

- **Context取消检查**：验证所有context.Context已取消
- **端口释放检查**：尝试连接代理端口确认已释放
- **进程运行检查**：使用pgrep检查进程是否仍在运行
- **文件存在检查**：使用os.Stat检查关键文件是否仍存在

这些改进确保了auto-proxy停止时的完整性和可靠性，解决了进程残留和文件清理不完整的问题。

## 清理的文件类型

### V2Ray相关临时文件
- `temp_v2ray_config_*.json`
- `test_v2ray_config_*.json`
- `proxy_server_v2ray_*.json`
- `temp_config_*.json`
- `test_proxy_*.json`

### Hysteria2相关临时文件
- `./hysteria2/test_config_*.yaml`
- `./hysteria2/temp_*.yaml`
- `./hysteria2/config_*.yaml`
- `./hysteria2/test_proxy_*.yaml`
- `./hysteria2/proxy_server_*.yaml`

### Auto-proxy相关文件
- `auto_proxy_best_node.json`
- `auto_proxy_state.json`
- `valid_nodes.json`
- `mvp_best_node.json`
- `proxy_state.json`

### 通用临时文件
- `*.tmp`
- `*.temp`

## 注意事项

1. **重要配置文件保护**: 清理过程会跳过重要的配置文件（如 `./hysteria2/config.yaml` 主配置文件）

2. **重启后恢复**: 清理后，重新启动auto-proxy服务会自动重新创建必要的文件

3. **进程清理**: 除了文件清理，停止时还会清理相关的v2ray和hysteria2进程

4. **安全性**: 清理操作只删除明确标识的临时文件，不会误删用户数据

## 版本历史

- **v1.1**: 增加完善的文件清理机制
- **v1.0**: 初始版本，存在文件清理不完整的问题 